{% extends 'base.html' %}
{% load custom_filters %}
{% load static %}
{% include 'react_scripts_base.html' %}

{% block content %}
{% csrf_token %}
<div class="historico-container">
    <!-- Breadcrumb Navegação Estrutural UX Moderno -->
    <div class="breadcrumb-container">
        <nav aria-label="Navegação estrutural" role="navigation">
            <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
                <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
                    <a href="{% url 'home' %}" class="breadcrumb-link" itemprop="item" title="Ir para Dashboard Principal" aria-label="Voltar ao Dashboard">
                        <i class="fas fa-home" aria-hidden="true"></i>
                        <span itemprop="name">Dashboard</span>
                    </a>
                    <meta itemprop="position" content="1">
                </li>
                <li class="breadcrumb-item current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
                    <i class="fas fa-history" aria-hidden="true"></i>
                    <span itemprop="name">Histórico</span>
                    <meta itemprop="position" content="2">
                </li>
            </ol>
        </nav>
    </div>

    <!-- Header da Página -->
    <div class="page-header">
        <div class="header-content">
            <div class="header-info">
                <div class="header-icon">
                    <i class="fas fa-history"></i>
                </div>
                <div class="header-text">
                    <h1>Histórico de Chamadas</h1>
                    <p>Histórico completo de chamadas registradas no sistema</p>
                </div>
            </div>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-number">{{ total_chamadas|default:"0" }}</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ chamadas_hoje|default:"0" }}</div>
                    <div class="stat-label">Hoje</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ chamadas_mes|default:"0" }}</div>
                    <div class="stat-label">Este Mês</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filtros-section">
        <div class="filtros-header">
            <h3><i class="fas fa-filter"></i> Filtrar Registros</h3>
            <div class="filtros-actions">
                <button type="button" class="btn btn-secondary" onclick="limparFiltros()">
                    <i class="fas fa-broom"></i> Limpar
                </button>
                <button type="button" class="btn btn-primary" onclick="aplicarFiltros()">
                    <i class="fas fa-search"></i> Filtrar
                </button>
            </div>
        </div>
        
        <form method="GET" id="filtrosForm" class="filtros-form">
            <div class="filtros-grid">
                <div class="filtro-item">
                    <label><i class="fas fa-search"></i> Buscar</label>
                    <input type="text" name="busca" value="{{ filtros.busca }}" 
                           placeholder="Nome, telefone, unidade..." class="form-control">
                </div>
                <div class="filtro-item">
                    <label><i class="fas fa-calendar"></i> Data Início</label>
                    <input type="date" name="data_inicio" value="{{ filtros.data_inicio }}" class="form-control">
                </div>
                <div class="filtro-item">
                    <label><i class="fas fa-calendar"></i> Data Fim</label>
                    <input type="date" name="data_fim" value="{{ filtros.data_fim }}" class="form-control">
                </div>
            </div>
        </form>
    </div>

    <!-- Tabela de Resultados -->
    <div class="resultados-section">
        <div class="resultados-header">
            <div class="resultados-info">
                <h3><i class="fas fa-table"></i> Registros Encontrados</h3>
                <span class="resultados-count">{{ chamadas|length }} registro{% if chamadas|length != 1 %}s{% endif %}</span>
            </div>
            <div class="resultados-actions">
                <div class="export-section-modern">
                    <div class="export-header" onclick="toggleExportOptions()">
                        <div class="export-header-content">
                            <i class="fas fa-download"></i>
                            <span class="export-title">Exportar</span>
                        </div>
                        <div class="export-toggle-icon">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="export-options" id="exportOptions" style="display: none;">
                        <div class="export-option" onclick="exportarPDF()">
                            <div class="export-icon pdf-icon">
                                <i class="fas fa-file-pdf"></i>
                            </div>
                            <div class="export-info">
                                <span class="export-format">PDF</span>
                                <span class="export-description">Documento portátil</span>
                            </div>
                            </div>
                        <div class="export-option" onclick="exportarExcel()">
                            <div class="export-icon excel-icon">
                                <i class="fas fa-file-excel"></i>
                            </div>
                            <div class="export-info">
                                <span class="export-format">Excel</span>
                                <span class="export-description">Planilha editável</span>
                            </div>
                            </div>
                        </div>
                            </div>
            </div>
        </div>

        <div class="table-container">
        {% if chamadas %}
        <div class="table-responsive">
            <table class="table-registros">
                <thead>
                    <tr>
                        <th class="th-codigo">Código</th>
                        <th class="th-data">Data</th>
                            <th class="th-hora">Hora</th>
                        <th class="th-solicitante">Solicitante</th>
                        <th class="th-telefone">Telefone</th>
                            <th class="th-unidade">Unidade</th>
                        <th class="th-tipo">Tipo</th>
                            <th class="th-acao">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    {% for chamada in chamadas %}
                        <tr class="registro-row">
                         <td class="td-codigo">
                             <div class="codigo-badge">
                                 #{{ chamada.id|stringformat:"04d" }}
                            </div>
                        </td>
                        <td class="td-data">
                            <div class="data-display">
                                <span class="data">{{ chamada.data_criacao|date:"d/m/Y" }}</span>
                            </div>
                        </td>
                            <td class="td-hora">
                                <div class="hora-display">
                                    <span class="hora">{{ chamada.data_criacao|date:"H:i" }}</span>
                            </div>
                        </td>
                        <td class="td-solicitante">
                            <div class="solicitante-info">
                                <div class="nome">{{ chamada.nome_contato }}</div>
                                {% if chamada.funcao %}
                                <div class="funcao">{{ chamada.funcao }}</div>
                                {% endif %}
                            </div>
                        </td>
                            <td class="td-telefone">
                                <div class="telefone-display-simple">
                                    <a href="tel:{{ chamada.telefone }}" class="telefone-link-simple" title="Clique para ligar: {{ chamada.telefone|format_telefone }}">
                                        <i class="fas fa-phone telefone-icon-simple"></i>
                                        <span class="telefone-numero-completo">{{ chamada.telefone|format_telefone }}</span>
                                    </a>
                            </div>
                        </td>
                        <td class="td-unidade">
                            <div class="unidade-info">
                                <div class="nome-unidade">{{ chamada.unidade|truncatechars:30 }}</div>
                                {% if chamada.municipio %}
                                <div class="municipio">{{ chamada.municipio }}</div>
                                {% endif %}
                             </div>
                         </td>
                        <td class="td-tipo">
                            <div class="tipo-badge tipo-{{ chamada.tipo_chamada }}">
                                {{ chamada.get_tipo_chamada_display|default:chamada.tipo_chamada|truncatechars:20 }}
                            </div>
                        </td>
                        <td class="td-acao">
                            <div class="acoes-group">
                                    <button class="btn-acao btn-visualizar" onclick="verDetalhes({{ chamada.id }})" title="Visualizar detalhes">
                                     <i class="fas fa-eye"></i>
                                 </button>
                                    <button class="btn-acao btn-editar" onclick="editarChamada({{ chamada.id }})" title="Editar chamada">
                                     <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-search-minus"></i>
            </div>
            <h3>Nenhum registro encontrado</h3>
            <p>Não foram encontradas chamadas com os filtros aplicados.</p>
            <button class="btn btn-primary" onclick="limparFiltros()">
                <i class="fas fa-broom"></i> Limpar Filtros
            </button>
        </div>
        {% endif %}
        </div>
    </div>
</div>

<!-- Modal de Detalhes -->
<div class="modal fade" id="detalhesModal" tabindex="-1" aria-labelledby="detalhesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content modal-detalhes">
            <div class="modal-header modal-header-detalhes">
                <div class="modal-header-content">
                    <div class="modal-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="modal-title-section">
                        <h4 class="modal-title-detalhes" id="detalhesModalLabel">Detalhes da Chamada</h4>
                        <p class="modal-subtitle-detalhes">Informações completas do registro</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-body-detalhes" id="detalhesContent">
                <!-- Conteúdo será carregado via JavaScript -->
                <div class="detalhes-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p>Carregando detalhes da chamada...</p>
                </div>
            </div>
            <div class="modal-footer modal-footer-detalhes">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="btn btn-primary" onclick="imprimirDetalhes()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Edição -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-labelledby="editarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content modal-editar">
            <div class="modal-header modal-header-editar">
                <div class="modal-header-content">
                    <div class="modal-icon modal-icon-editar">
                        <i class="fas fa-edit"></i>
                    </div>
                    <div class="modal-title-section">
                        <h4 class="modal-title-editar" id="editarModalLabel">Editar Chamada</h4>
                        <p class="modal-subtitle-editar">Modifique as informações da chamada</p>
                    </div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body modal-body-editar" id="editarContent">
                <!-- Conteúdo será carregado via JavaScript -->
                <div class="editar-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p>Carregando formulário de edição...</p>
                </div>
            </div>
            <div class="modal-footer modal-footer-editar">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="btn btn-warning" onclick="resetarFormulario()">
                    <i class="fas fa-undo"></i> Resetar
                </button>
                <button type="button" class="btn btn-success" onclick="salvarChamada()" id="btnSalvarChamada">
                    <i class="fas fa-save"></i> Salvar Alterações
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* ===== MODAIS ===== */
.modal-detalhes .modal-content,
.modal-editar .modal-content {
    border: none;
    border-radius: 20px;
     box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
 }

.modal-header-detalhes,
.modal-header-editar {
    background: linear-gradient(135deg, #10b981, #059669);
     color: white;
    border-radius: 20px 20px 0 0;
     padding: 2rem;
    border: none;
 }

 .modal-header-content {
     display: flex;
     align-items: center;
     gap: 1.5rem;
    flex: 1;
 }

 .modal-icon {
     width: 60px;
     height: 60px;
     background: rgba(255, 255, 255, 0.2);
    border-radius: 15px;
     display: flex;
     align-items: center;
     justify-content: center;
    font-size: 1.5rem;
}

.modal-icon-editar {
    background: rgba(245, 158, 11, 0.2);
}

.modal-title-detalhes,
.modal-title-editar {
    font-size: 1.5rem;
     font-weight: 700;
     margin: 0;
 }

.modal-subtitle-detalhes,
.modal-subtitle-editar {
     font-size: 1rem;
     margin: 0.5rem 0 0 0;
     opacity: 0.9;
 }

.btn-close {
     background: rgba(255, 255, 255, 0.2);
    border: none;
    border-radius: 50%;
     width: 40px;
     height: 40px;
     display: flex;
     align-items: center;
     justify-content: center;
     color: white;
     font-size: 1rem;
    opacity: 1;
}

.btn-close:hover {
    background: rgba(255, 255, 255, 0.3);
     color: white;
}

.modal-body-detalhes,
  .modal-body-editar {
      padding: 2rem;
    max-height: 60vh;
      overflow-y: auto;
  }

.modal-footer-detalhes,
  .modal-footer-editar {
      padding: 1.5rem 2rem;
    border: none;
      gap: 1rem;
  }

/* Estilo dos detalhes */
.detalhes-grid {
      display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }

.detalhe-item {
    background: #f8fafc;
      padding: 1.5rem;
    border-radius: 12px;
    border-left: 4px solid #10b981;
  }

.detalhe-label {
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    gap: 0.5rem;
}

.detalhe-valor {
      color: #64748b;
    font-size: 1rem;
    line-height: 1.4;
  }

/* Estilo do formulário de edição */
.edicao-container {
    padding: 0;
}

.edicao-sections {
    display: flex;
    flex-direction: column;
    gap: 2rem;
}

.edicao-section {
    background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 2rem;
    transition: all 0.3s ease;
}

.edicao-section:hover {
    border-color: #10b981;
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.1);
    transform: translateY(-2px);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
}

.section-icon {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #10b981, #059669);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 1.3rem;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.section-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
}

.section-description {
    font-size: 0.9rem;
    color: #64748b;
    margin: 0.25rem 0 0 0;
    font-weight: 500;
}

.edicao-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}

.edicao-item {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    position: relative;
}

.edicao-label {
    font-weight: 700;
    color: #1e293b;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.edicao-label i {
    font-size: 1.1rem;
    width: 20px;
    text-align: center;
}

.required-indicator {
    color: #ef4444;
    font-weight: 900;
    margin-left: 0.25rem;
}

.input-container {
    position: relative;
}

.edicao-input {
    width: 100%;
    padding: 1rem 1.25rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
}

.edicao-input:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1), 0 4px 15px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

.edicao-input:valid {
    border-color: #22c55e;
}

.edicao-input:invalid:not(:placeholder-shown) {
    border-color: #ef4444;
}

.edicao-textarea {
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
    line-height: 1.5;
}

.edicao-select {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 3rem;
    appearance: none;
}

/* Estados visuais dos inputs */
.input-success {
    border-color: #22c55e !important;
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1) !important;
}

.input-error {
    border-color: #ef4444 !important;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1) !important;
}

.input-warning {
    border-color: #f59e0b !important;
    box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1) !important;
}

/* Indicadores de validação */
.validation-icon {
    position: absolute;
    top: 50%;
    right: 1rem;
    transform: translateY(-50%);
    font-size: 1.1rem;
    pointer-events: none;
    opacity: 0;
    transition: all 0.3s ease;
}

.validation-icon.success {
    color: #22c55e;
    opacity: 1;
}

.validation-icon.error {
    color: #ef4444;
    opacity: 1;
}

.validation-icon.warning {
    color: #f59e0b;
    opacity: 1;
}

/* Mensagens de ajuda */
.help-text {
    font-size: 0.85rem;
    color: #64748b;
    margin-top: 0.5rem;
    font-weight: 500;
    line-height: 1.4;
}

.help-text.error {
    color: #ef4444;
}

.help-text.success {
    color: #22c55e;
}

/* Campos especiais */
.campo-destacado {
    background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
    border: 2px solid rgba(16, 185, 129, 0.2);
}

.campo-destacado .edicao-label {
    color: #059669;
}

/* Animações */
@keyframes inputFocus {
    0% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.02);
    }
    100% {
        transform: scale(1);
    }
}

.edicao-input:focus {
    animation: inputFocus 0.3s ease;
}

/* Contador de caracteres */
.char-counter {
    position: absolute;
    bottom: -1.5rem;
    right: 0;
    font-size: 0.75rem;
    color: #94a3b8;
    font-weight: 600;
}

.char-counter.warning {
    color: #f59e0b;
}

.char-counter.danger {
    color: #ef4444;
}

/* Estados especiais do modal */
.modal-content.saving {
    opacity: 0.8;
    pointer-events: none;
    position: relative;
}

.modal-content.saving::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(16, 185, 129, 0.1);
    z-index: 1000;
    animation: pulse 1.5s infinite;
}

.modal-content.success {
    animation: successFlash 0.8s ease;
}

.section-error {
    border-color: #ef4444 !important;
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05)) !important;
    animation: shake 0.5s ease-in-out;
}

/* Animações */
@keyframes pulse {
    0%, 100% {
        opacity: 0.1;
    }
    50% {
        opacity: 0.3;
    }
}

@keyframes successFlash {
    0% {
        border-color: #22c55e;
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
    }
    50% {
        border-color: #22c55e;
        box-shadow: 0 0 0 20px rgba(34, 197, 94, 0);
    }
    100% {
        border-color: #e2e8f0;
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
    }
}

@keyframes shake {
    0%, 100% {
        transform: translateX(0);
    }
    25% {
        transform: translateX(-5px);
    }
    75% {
        transform: translateX(5px);
    }
}

@keyframes updateHighlight {
    0% {
        background: rgba(34, 197, 94, 0.1);
        transform: scale(1);
    }
    50% {
        background: rgba(34, 197, 94, 0.3);
        transform: scale(1.02);
    }
    100% {
        background: transparent;
        transform: scale(1);
    }
}

@keyframes slideInRight {
    0% {
        transform: translateX(100%);
        opacity: 0;
    }
    100% {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes fadeOut {
    0% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}

/* Indicador de atualização */
.update-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.update-indicator i {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

@keyframes fieldUpdateHighlight {
    0% {
        background: rgba(34, 197, 94, 0.1);
        border-left: 4px solid #22c55e;
        transform: translateX(0);
    }
    50% {
        background: rgba(34, 197, 94, 0.2);
        border-left: 4px solid #22c55e;
        transform: translateX(5px);
    }
    100% {
        background: transparent;
        border-left: 4px solid transparent;
        transform: translateX(0);
    }
}

/* Campos atualizados */
.field-updated {
    background: rgba(34, 197, 94, 0.1);
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #22c55e;
    position: relative;
    transition: all 0.3s ease;
}

.field-updated .detalhe-label {
    font-weight: 600;
    color: #059669;
}

/* Badge de atualização */
.update-badge {
    display: inline-block;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-weight: 700;
    margin-left: 0.5rem;
    animation: pulse 2s infinite;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* Efeito hover para campos atualizados */
.field-updated:hover {
    background: rgba(34, 197, 94, 0.15);
    border-left-color: #059669;
    transform: translateX(2px);
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.2);
}

/* Overlay de sucesso para salvamento */
.success-modal {
    background: linear-gradient(135deg, #ffffff 0%, #f0fdf4 100%);
    border-radius: 20px;
    padding: 3rem 2.5rem;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
    text-align: center;
    max-width: 450px;
    width: 90%;
    border: 2px solid #22c55e;
    animation: successBounce 0.6s ease-out;
}

.success-icon {
    font-size: 4rem;
    color: #22c55e;
    margin-bottom: 1.5rem;
    animation: successIconPulse 1.5s ease-in-out infinite;
}

.success-title {
    color: #059669;
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1rem;
    text-shadow: 0 2px 4px rgba(5, 150, 105, 0.1);
}

.success-message {
    color: #065f46;
    font-size: 1.1rem;
    line-height: 1.6;
    margin-bottom: 2rem;
    opacity: 0.9;
}

.success-loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.75rem;
}

.loading-bar {
    width: 100%;
    height: 6px;
    background: rgba(34, 197, 94, 0.2);
    border-radius: 3px;
    overflow: hidden;
    position: relative;
}

.loading-progress {
    height: 100%;
    background: linear-gradient(90deg, #22c55e, #16a34a);
    width: 0%;
    border-radius: 3px;
    animation: loadingProgress 2s ease-in-out;
    box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

.success-loading small {
    color: #059669;
    font-weight: 600;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-size: 0.85rem;
}

@keyframes successBounce {
    0% {
        opacity: 0;
        transform: scale(0.3) translateY(-100px);
    }
    50% {
        opacity: 1;
        transform: scale(1.05) translateY(0);
    }
    70% {
        transform: scale(0.98);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

@keyframes successIconPulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.1);
    }
}

@keyframes loadingProgress {
    0% {
        width: 0%;
    }
    100% {
        width: 100%;
    }
}

/* Melhorias visuais gerais */
.edicao-input:focus {
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1), 0 4px 15px rgba(0, 0, 0, 0.1) !important;
}

.edicao-section:focus-within {
    border-color: #10b981;
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.1);
}

/* Estilo para botões do modal */
.modal-footer-editar .btn {
    min-width: 160px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
}

.modal-footer-editar .btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

.modal-footer-editar .btn-success {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border: none;
    box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
}

.modal-footer-editar .btn-success:hover:not(:disabled) {
    background: linear-gradient(135deg, #16a34a, #15803d);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
}

.modal-footer-editar .btn-warning {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    border: none;
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
}

.modal-footer-editar .btn-warning:hover:not(:disabled) {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
}

/* Loading states */
.detalhes-loading,
.editar-loading {
      display: flex;
    flex-direction: column;
      align-items: center;
    gap: 1rem;
      padding: 2rem;
      color: #64748b;
}

/* Estados de foco dos campos */
.edicao-item.focused {
    transform: scale(1.02);
    transition: all 0.3s ease;
}

.edicao-item.focused .edicao-section {
    border-color: #10b981;
    box-shadow: 0 8px 25px rgba(16, 185, 129, 0.15);
}

/* Responsividade dos modais */
@media (max-width: 1200px) {
    .modal-xl {
        max-width: 95%;
    }
    
    .edicao-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

@media (max-width: 768px) {
    .modal-dialog {
        margin: 0.5rem;
        max-width: calc(100% - 1rem);
    }
    
    .modal-header-detalhes,
    .modal-header-editar {
        padding: 1.5rem;
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .modal-header-content {
        flex-direction: column;
        text-align: center;
    }
    
    .modal-icon {
        width: 70px;
        height: 70px;
        font-size: 2rem;
    }
    
    .modal-body-detalhes,
    .modal-body-editar {
        padding: 1rem;
        max-height: 70vh;
    }
    
    .modal-footer-detalhes,
    .modal-footer-editar {
        padding: 1rem;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .modal-footer-detalhes .btn,
    .modal-footer-editar .btn {
        width: 100%;
        justify-content: center;
    }
    
    .detalhes-grid,
    .edicao-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .edicao-sections {
        gap: 1.5rem;
    }
    
    .edicao-section {
        padding: 1.5rem;
        border-radius: 12px;
    }
    
    .section-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .section-icon {
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
    }
    
    .section-title {
        font-size: 1.2rem;
    }
    
    .section-description {
        font-size: 0.85rem;
    }
    
    .edicao-input {
        padding: 0.875rem 1rem;
        font-size: 0.95rem;
    }
    
    .edicao-textarea {
        min-height: 100px;
    }
    
    .char-counter {
        bottom: -1.25rem;
        font-size: 0.7rem;
    }
}

@media (max-width: 480px) {
    .modal-dialog {
        margin: 0;
        max-width: 100%;
        height: 100vh;
    }
    
    .modal-content {
        border-radius: 0;
        height: 100vh;
        overflow: hidden;
    }
    
    .modal-header-detalhes,
    .modal-header-editar {
        padding: 1rem;
        border-radius: 0;
    }
    
    .modal-body-detalhes,
    .modal-body-editar {
        padding: 0.75rem;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
    }
    
    .modal-footer-detalhes,
    .modal-footer-editar {
        padding: 1rem;
        position: sticky;
        bottom: 0;
        background: white;
        border-top: 2px solid #e2e8f0;
    }
    
    .edicao-sections {
        gap: 1rem;
    }
    
    .edicao-section {
        padding: 1rem;
        border-radius: 8px;
    }
    
    .section-header {
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
    }
    
    .section-icon {
        width: 50px;
        height: 50px;
        font-size: 1.2rem;
    }
    
    .section-title {
        font-size: 1.1rem;
    }
    
    .section-description {
        font-size: 0.8rem;
    }
    
    .edicao-item {
        gap: 0.5rem;
    }
    
    .edicao-label {
        font-size: 0.9rem;
        gap: 0.5rem;
    }
    
    .edicao-input {
        padding: 0.75rem;
        font-size: 0.9rem;
        border-radius: 8px;
    }
    
    .help-text {
        font-size: 0.75rem;
        margin-top: 0.25rem;
    }
    
    .btn {
        padding: 0.875rem 1.5rem;
        font-size: 0.9rem;
    }
}

<style>
/* ===== CONTAINER PRINCIPAL ===== */
.historico-container {
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    min-height: 100vh;
}

/* ===== BREADCRUMB UX MODERNO E PROFISSIONAL ===== */
.breadcrumb-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 1.25rem 2rem;
    margin-bottom: 2rem;
    border: 1px solid rgba(226, 232, 240, 0.8);
    box-shadow: 
        0 4px 6px -1px rgba(0, 0, 0, 0.05),
        0 2px 4px -1px rgba(0, 0, 0, 0.03),
        0 0 0 1px rgba(255, 255, 255, 0.05);
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.breadcrumb-container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, 
        #3b82f6 0%, 
        #8b5cf6 25%, 
        #06b6d4 50%, 
        #10b981 75%, 
        #f59e0b 100%);
    opacity: 0.6;
    animation: shimmer 3s ease-in-out infinite;
}

.breadcrumb-container:hover {
    transform: translateY(-1px);
    box-shadow: 
        0 10px 15px -3px rgba(0, 0, 0, 0.08),
        0 4px 6px -2px rgba(0, 0, 0, 0.05),
        0 0 0 1px rgba(255, 255, 255, 0.1);
}

.breadcrumb {
    display: flex;
    align-items: center;
    margin: 0;
    padding: 0;
    list-style: none;
    gap: 0.75rem;
    font-size: 0.9rem;
    font-weight: 500;
    letter-spacing: 0.025em;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    position: relative;
    animation: slideInUp 0.5s ease-out;
}

.breadcrumb-item:not(:last-child)::after {
    content: '';
    width: 6px;
    height: 6px;
    background: linear-gradient(45deg, #cbd5e1, #94a3b8);
    border-radius: 50%;
    margin-left: 0.75rem;
    opacity: 0.7;
    animation: pulse 2s infinite;
}

.breadcrumb-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #475569;
    text-decoration: none;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 0.5rem 0.875rem;
    border-radius: 10px;
    position: relative;
    overflow: hidden;
    background: rgba(255, 255, 255, 0.5);
    border: 1px solid rgba(226, 232, 240, 0.5);
}

.breadcrumb-link::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, 
        transparent, 
        rgba(59, 130, 246, 0.1), 
        transparent);
    transition: left 0.6s ease;
}

.breadcrumb-link:hover::before {
    left: 100%;
}

.breadcrumb-link:hover {
    color: #1e40af;
    background: rgba(59, 130, 246, 0.05);
    border-color: rgba(59, 130, 246, 0.2);
    transform: translateY(-1px) scale(1.02);
    box-shadow: 
        0 4px 8px rgba(59, 130, 246, 0.15),
        0 2px 4px rgba(59, 130, 246, 0.1);
}

.breadcrumb-link:active {
    transform: translateY(0) scale(0.98);
}

.breadcrumb-link i {
    font-size: 0.875rem;
    transition: all 0.3s ease;
    background: linear-gradient(45deg, #3b82f6, #6366f1);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.breadcrumb-link:hover i {
    transform: scale(1.1) rotate(5deg);
}

.breadcrumb-item.current {
    color: #ffffff;
    font-weight: 700;
    background: linear-gradient(135deg, #f59e0b 0%, #f97316 100%);
    padding: 0.5rem 1rem;
    border-radius: 10px;
    border: 1px solid rgba(245, 158, 11, 0.3);
    box-shadow: 
        0 4px 8px rgba(245, 158, 11, 0.25),
        0 2px 4px rgba(245, 158, 11, 0.15),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    position: relative;
    overflow: hidden;
    animation: slideInUp 0.6s ease-out 0.2s both;
}

.breadcrumb-item.current::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: conic-gradient(
        from 0deg,
        transparent,
        rgba(255, 255, 255, 0.1),
        transparent
    );
    animation: rotate 4s linear infinite;
}

.breadcrumb-item.current i {
    font-size: 0.875rem;
    margin-right: 0.375rem;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    animation: bounce 2s infinite;
    position: relative;
    z-index: 1;
}

.breadcrumb-item.current span {
    position: relative;
    z-index: 1;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

/* ===== ANIMAÇÕES BREADCRUMB ===== */
@keyframes shimmer {
    0%, 100% {
        opacity: 0.6;
        transform: translateX(-100%);
    }
    50% {
        opacity: 1;
        transform: translateX(100%);
    }
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes pulse {
    0%, 100% {
        opacity: 0.7;
        transform: scale(1);
    }
    50% {
        opacity: 1;
        transform: scale(1.2);
    }
}

@keyframes rotate {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

@keyframes bounce {
    0%, 20%, 50%, 80%, 100% {
        transform: translateY(0);
    }
    40% {
        transform: translateY(-3px);
    }
    60% {
        transform: translateY(-1px);
    }
}

/* ===== ESTILOS PARA INDICADORES DE ATUALIZAÇÃO ===== */
.update-badge {
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 700;
    margin-left: 0.5rem;
    display: inline-block;
    animation: pulseGreen 2s infinite;
    box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
}

.field-updated {
    border-left-color: #22c55e !important;
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%) !important;
    animation: highlightUpdate 1s ease-out;
}

@keyframes pulseGreen {
    0%, 100% {
        box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
    }
    50% {
        box-shadow: 0 4px 15px rgba(34, 197, 94, 0.6);
        transform: scale(1.05);
    }
}

@keyframes highlightUpdate {
    0% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(34, 197, 94, 0.1);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0);
    }
}

@keyframes slideInRight {
    0% {
        opacity: 0;
        transform: translateX(30px);
    }
    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes fadeOut {
    0% {
        opacity: 1;
    }
    100% {
        opacity: 0;
    }
}

/* ===== HEADER DA PÁGINA ===== */
.page-header {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    border-radius: 20px;
    padding: 3rem 2.5rem;
    margin-bottom: 2rem;
    color: white;
    box-shadow: 0 10px 40px rgba(16, 185, 129, 0.3);
    position: relative;
    overflow: hidden;
}

.page-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -20%;
    width: 300px;
    height: 300px;
    background: rgba(255, 255, 255, 0.1);
    border-radius: 50%;
    animation: float 6s ease-in-out infinite;
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 2rem;
    position: relative;
    z-index: 2;
}

.header-info {
    display: flex;
    align-items: center;
    gap: 2rem;
    flex: 1;
}

.header-icon {
    width: 100px;
    height: 100px;
    background: rgba(255, 255, 255, 0.15);
    border-radius: 25px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 3rem;
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.2);
}

.header-text h1 {
    font-size: 3rem;
    font-weight: 800;
    margin: 0;
    text-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    background: linear-gradient(45deg, #ffffff, #f0fdf4);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.header-text p {
    font-size: 1.25rem;
    margin: 0.75rem 0 0 0;
    opacity: 0.9;
    font-weight: 500;
}

.header-stats {
    display: flex;
    gap: 1.5rem;
}

.stat-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(15px);
    border-radius: 15px;
    padding: 1.5rem 2rem;
    border: 2px solid rgba(255, 255, 255, 0.2);
    min-width: 120px;
    transition: all 0.3s ease;
}

.stat-item:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.2);
}

.stat-number {
    font-size: 2rem;
    font-weight: 800;
    line-height: 1;
    display: block;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.8;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
    margin-top: 0.5rem;
}

/* ===== FILTROS ===== */
.filtros-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 2.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.1);
}

.filtros-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid rgba(16, 185, 129, 0.1);
}

.filtros-header h3 {
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.5rem;
    font-weight: 700;
}

.filtros-header h3 i {
    color: #10b981;
}

.filtros-actions {
    display: flex;
    gap: 1rem;
}

.filtros-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.filtro-item {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.filtro-item label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
    color: #1e293b;
    font-size: 1rem;
}

.filtro-item label i {
    color: #10b981;
}

.form-control {
    padding: 1rem 1.25rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: white;
    font-weight: 500;
}

.form-control:focus {
    outline: none;
    border-color: #10b981;
    box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
    transform: translateY(-2px);
}

.btn {
    display: inline-flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.75rem;
    border: none;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.btn-primary {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
}

.btn-primary:hover {
    background: linear-gradient(135deg, #059669, #047857);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
}

.btn-secondary {
    background: linear-gradient(135deg, #64748b, #475569);
     color: white;
    box-shadow: 0 4px 15px rgba(100, 116, 139, 0.2);
}

.btn-secondary:hover {
    background: linear-gradient(135deg, #475569, #334155);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(100, 116, 139, 0.3);
}

/* ===== RESULTADOS ===== */
.resultados-section {
    background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    border-radius: 20px;
    padding: 2.5rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    border: 1px solid rgba(16, 185, 129, 0.1);
}

    .resultados-header {
    display: flex;
        justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid rgba(16, 185, 129, 0.1);
}

.resultados-info h3 {
    color: #1e293b;
    margin: 0 0 0.5rem 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
         font-size: 1.5rem;
      font-weight: 700;
}

.resultados-info h3 i {
    color: #10b981;
}

.resultados-count {
      color: #64748b;
      font-size: 1rem;
      font-weight: 600;
}

/* ===== EXPORT ===== */
.export-section-modern {
            position: relative;
}

.export-header {
    display: flex;
    align-items: center;
        gap: 1rem;
    padding: 1rem 1.75rem;
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 700;
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
}

.export-header:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-3px);
    box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
}

.export-options {
    position: absolute;
    top: 100%;
    right: 0;
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
    z-index: 1000;
    min-width: 250px;
    margin-top: 0.75rem;
    overflow: hidden;
}

.export-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    cursor: pointer;
    transition: all 0.3s ease;
    border-bottom: 1px solid #f1f5f9;
}

.export-option:last-child {
    border-bottom: none;
}

.export-option:hover {
    background: #f8fafc;
    transform: translateX(5px);
}

.export-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.export-icon.pdf-icon {
    background: linear-gradient(135deg, #ef4444, #dc2626);
}

.export-icon.excel-icon {
    background: linear-gradient(135deg, #22c55e, #16a34a);
}

.export-format {
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
    display: block;
    font-size: 1.1rem;
}

.export-description {
    font-size: 0.9rem;
    color: #64748b;
    font-weight: 500;
}

/* ===== TABELA ===== */
.table-container {
    margin-top: 1.5rem;
}

.table-responsive {
    overflow-x: auto;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
}

.table-registros {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 16px;
    overflow: hidden;
}

.table-registros th,
.table-registros td {
    padding: 1.25rem;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
}

.table-registros th {
    background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
    font-weight: 700;
    color: #1e293b;
    font-size: 1rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    position: sticky;
    top: 0;
    z-index: 10;
}

.registro-row {
    transition: all 0.3s ease;
}

.registro-row:hover {
    background: rgba(16, 185, 129, 0.05);
    transform: scale(1.01);
}

.codigo-badge {
    background: linear-gradient(135deg, #10b981, #059669);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 700;
    display: inline-block;
    box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
}

.data-display, .hora-display {
    font-weight: 600;
    color: #1e293b;
    font-size: 1rem;
}

.solicitante-info .nome {
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 0.25rem;
    font-size: 1rem;
}

.solicitante-info .funcao {
    font-size: 0.85rem;
    color: #64748b;
    font-weight: 500;
}

.unidade-info .nome-unidade {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
}

.unidade-info .municipio {
    font-size: 0.8rem;
    color: #64748b;
    font-weight: 500;
}

.telefone-display-simple .telefone-link-simple {
     display: flex;
     align-items: center;
     gap: 0.5rem;
    color: #10b981;
     text-decoration: none;
    padding: 0.75rem;
    border-radius: 10px;
    transition: all 0.3s ease;
     font-weight: 600;
}

.telefone-display-simple .telefone-link-simple:hover {
    background: rgba(16, 185, 129, 0.1);
    color: #059669;
    transform: translateY(-2px);
 }

.tipo-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-size: 0.85rem;
    font-weight: 700;
    background: linear-gradient(135deg, #e2e8f0, #cbd5e1);
    color: #64748b;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.acoes-group {
    display: flex;
    gap: 0.75rem;
}

.btn-acao {
    width: 40px;
    height: 40px;
    border: none;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.btn-visualizar {
    background: linear-gradient(135deg, #3b82f6, #2563eb);
    color: white;
}

.btn-visualizar:hover {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
}

.btn-editar {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
}

.btn-editar:hover {
    background: linear-gradient(135deg, #d97706, #b45309);
    transform: translateY(-3px);
    box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
}

/* ===== EMPTY STATE ===== */
.empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
}

.empty-icon {
    font-size: 5rem;
    color: #cbd5e1;
    margin-bottom: 1.5rem;
    animation: float 3s ease-in-out infinite;
}

.empty-state h3 {
    color: #1e293b;
    margin-bottom: 1rem;
    font-size: 1.5rem;
    font-weight: 700;
}

.empty-state p {
    margin-bottom: 2rem;
    font-size: 1.1rem;
}

/* ===== ANIMAÇÕES ===== */
@keyframes float {
    0%, 100% {
        transform: translateY(0px);
    }
    50% {
        transform: translateY(-20px);
    }
}

/* ===== RESPONSIVIDADE ===== */
@media (max-width: 1200px) {
    .historico-container {
        padding: 1.5rem;
    }

    .header-stats {
        gap: 1rem;
    }

    .stat-item {
        padding: 1rem 1.5rem;
        min-width: 100px;
    }
}

@media (max-width: 768px) {
    .historico-container {
        padding: 1rem;
    }

    .breadcrumb-container {
        flex-direction: column;
     gap: 1.5rem;
        padding: 1.5rem;
    }

    .header-content {
        flex-direction: column;
     text-align: center;
     gap: 2rem;
 }

    .header-text h1 {
        font-size: 2rem;
    }

    .header-stats {
        flex-wrap: wrap;
     justify-content: center;
     gap: 1rem;
 }

    .stat-item {
        min-width: 80px;
     padding: 1rem;
    }

    .filtros-grid {
        grid-template-columns: 1fr;
    }

    .resultados-header {
        flex-direction: column;
        gap: 1.5rem;
    }

    .table-registros {
     font-size: 0.85rem;
    }

    .table-registros th,
    .table-registros td {
     padding: 0.75rem;
 }

    .acoes-group {
      flex-direction: column;
      gap: 0.5rem;
  }

    .btn-acao {
        width: 35px;
        height: 35px;
    }
}

@media (max-width: 480px) {
    .table-registros th,
    .table-registros td {
        padding: 0.5rem;
      font-size: 0.8rem;
  }

    .codigo-badge {
        padding: 0.25rem 0.75rem;
      font-size: 0.8rem;
  }

    .tipo-badge {
        padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      }
  }

/* ===== RESPONSIVIDADE BREADCRUMB ===== */
@media (max-width: 768px) {
    .breadcrumb-container {
        padding: 0.75rem 1rem;
        margin-bottom: 1.5rem;
    }
    
    .breadcrumb {
        font-size: 0.8rem;
        gap: 0.375rem;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        margin-left: 0.375rem;
    }
    
    .breadcrumb-link {
        padding: 0.2rem 0.375rem;
        gap: 0.375rem;
    }
    
    .breadcrumb-item.current {
        padding: 0.2rem 0.5rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .breadcrumb-container {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
    }
    
    .breadcrumb {
        font-size: 0.75rem;
        gap: 0.25rem;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        margin-left: 0.25rem;
    }
    
    .breadcrumb-link,
    .breadcrumb-item.current {
        padding: 0.15rem 0.25rem;
        gap: 0.25rem;
    }
    
    .breadcrumb-link i,
    .breadcrumb-item.current i {
        font-size: 0.75rem;
    }
}

/* ===== RESPONSIVIDADE BREADCRUMB AVANÇADA ===== */

/* Desktop Extra Large (1400px+) */
@media (min-width: 1400px) {
    .breadcrumb-container {
        padding: 1.5rem 2.5rem;
        margin-bottom: 2.5rem;
    }
    
    .breadcrumb {
        font-size: 1rem;
        gap: 1rem;
    }
    
    .breadcrumb-link {
        padding: 0.625rem 1rem;
    }
    
    .breadcrumb-item.current {
        padding: 0.625rem 1.25rem;
    }
}

/* Desktop Large (1200px - 1399px) */
@media (max-width: 1399px) and (min-width: 1200px) {
    .breadcrumb-container {
        padding: 1.25rem 2rem;
    }
    
    .breadcrumb {
        font-size: 0.95rem;
        gap: 0.875rem;
    }
}

/* Desktop Standard (992px - 1199px) */
@media (max-width: 1199px) and (min-width: 992px) {
    .breadcrumb-container {
        padding: 1.125rem 1.75rem;
        margin-bottom: 1.75rem;
    }
    
    .breadcrumb {
        font-size: 0.9rem;
        gap: 0.75rem;
    }
    
    .breadcrumb-link {
        padding: 0.5rem 0.75rem;
    }
    
    .breadcrumb-item.current {
        padding: 0.5rem 0.875rem;
    }
}

/* Tablet (768px - 991px) */
@media (max-width: 991px) and (min-width: 768px) {
    .breadcrumb-container {
        padding: 1rem 1.5rem;
        margin-bottom: 1.5rem;
        border-radius: 12px;
    }
    
    .breadcrumb {
        font-size: 0.875rem;
        gap: 0.625rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        width: 5px;
        height: 5px;
        margin-left: 0.625rem;
    }
    
    .breadcrumb-link {
        padding: 0.5rem 0.75rem;
        border-radius: 8px;
    }
    
    .breadcrumb-item.current {
        padding: 0.5rem 0.875rem;
        border-radius: 8px;
    }
    
    .breadcrumb-link i,
    .breadcrumb-item.current i {
        font-size: 0.8rem;
    }
}

/* Mobile Large (576px - 767px) */
@media (max-width: 767px) and (min-width: 576px) {
    .breadcrumb-container {
        padding: 0.875rem 1.25rem;
        margin-bottom: 1.25rem;
        border-radius: 10px;
    }
    
    .breadcrumb {
        font-size: 0.8rem;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        width: 4px;
        height: 4px;
        margin-left: 0.5rem;
    }
    
    .breadcrumb-link {
        padding: 0.375rem 0.625rem;
        border-radius: 6px;
        gap: 0.375rem;
    }
    
    .breadcrumb-item.current {
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        gap: 0.375rem;
    }
    
    .breadcrumb-link i,
    .breadcrumb-item.current i {
        font-size: 0.75rem;
    }
    
    /* Reduz animações em dispositivos móveis */
    .breadcrumb-container::before {
        animation-duration: 5s;
    }
    
    .breadcrumb-item.current::before {
        animation-duration: 6s;
    }
}

/* Mobile Medium (480px - 575px) */
@media (max-width: 575px) and (min-width: 480px) {
    .breadcrumb-container {
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 8px;
    }
    
    .breadcrumb {
        font-size: 0.75rem;
        gap: 0.375rem;
        justify-content: center;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        width: 3px;
        height: 3px;
        margin-left: 0.375rem;
    }
    
    .breadcrumb-link {
        padding: 0.3rem 0.5rem;
        border-radius: 5px;
        gap: 0.3rem;
    }
    
    .breadcrumb-item.current {
        padding: 0.3rem 0.625rem;
        border-radius: 5px;
        gap: 0.3rem;
    }
    
    .breadcrumb-link i,
    .breadcrumb-item.current i {
        font-size: 0.7rem;
    }
    
    /* Simplifica efeitos hover em dispositivos pequenos */
    .breadcrumb-link:hover {
        transform: none;
        scale: 1;
    }
    
    .breadcrumb-link:hover i {
        transform: scale(1.05);
    }
}

/* Mobile Small (320px - 479px) */
@media (max-width: 479px) {
    .breadcrumb-container {
        padding: 0.625rem 0.875rem;
        margin-bottom: 0.875rem;
        border-radius: 6px;
    }
    
    .breadcrumb {
        font-size: 0.7rem;
        gap: 0.25rem;
        justify-content: center;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        width: 2px;
        height: 2px;
        margin-left: 0.25rem;
    }
    
    .breadcrumb-link {
        padding: 0.25rem 0.375rem;
        border-radius: 4px;
        gap: 0.25rem;
        min-height: 32px;
        min-width: 32px;
        justify-content: center;
    }
    
    .breadcrumb-item.current {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        gap: 0.25rem;
        min-height: 32px;
    }
    
    .breadcrumb-link i,
    .breadcrumb-item.current i {
        font-size: 0.65rem;
        margin-right: 0.125rem;
    }
    
    /* Remove textos em telas muito pequenas, mantém apenas ícones + texto essencial */
    .breadcrumb-link span {
        display: none;
    }
    
    .breadcrumb-item.current span {
        font-size: 0.65rem;
    }
    
    /* Desabilita animações complexas */
    .breadcrumb-container::before,
    .breadcrumb-item.current::before {
        display: none;
    }
    
    .breadcrumb-item {
        animation: none;
    }
    
    .breadcrumb-link:hover {
        transform: none;
        scale: none;
    }
}

/* Mobile Extra Small (até 320px) */
@media (max-width: 320px) {
    .breadcrumb-container {
        padding: 0.5rem 0.625rem;
        margin-bottom: 0.75rem;
        border-radius: 4px;
    }
    
    .breadcrumb {
        font-size: 0.65rem;
        gap: 0.125rem;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        display: none;
    }
    
    .breadcrumb-link,
    .breadcrumb-item.current {
        padding: 0.2rem 0.3rem;
        border-radius: 3px;
        gap: 0.125rem;
        min-height: 28px;
    }
    
    .breadcrumb-link i,
    .breadcrumb-item.current i {
        font-size: 0.6rem;
    }
    
    .breadcrumb-item.current span {
        font-size: 0.6rem;
    }
}

/* Accessibility e Performance */
@media (prefers-reduced-motion: reduce) {
    .breadcrumb-container::before,
    .breadcrumb-item.current::before,
    .breadcrumb-item,
    .breadcrumb-link,
    .breadcrumb-item.current {
        animation: none !important;
        transition: none !important;
    }
}

/* High Contrast Mode */
@media (prefers-contrast: high) {
    .breadcrumb-container {
        border: 2px solid #000000;
        background: #ffffff;
    }
    
    .breadcrumb-link {
        color: #0000ff;
        border: 1px solid #000000;
    }
    
    .breadcrumb-item.current {
        background: #000000;
        color: #ffffff;
        border: 1px solid #000000;
    }
}

/* Dark Mode (se implementado futuramente) */
@media (prefers-color-scheme: dark) {
    .breadcrumb-container {
        background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        border-color: rgba(75, 85, 99, 0.8);
    }
    
    .breadcrumb-link {
        color: #93c5fd;
        background: rgba(59, 130, 246, 0.1);
        border-color: rgba(59, 130, 246, 0.2);
    }
    
    .breadcrumb-link:hover {
        color: #dbeafe;
        background: rgba(59, 130, 246, 0.2);
    }
    
    .breadcrumb-item.current {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    }
}

/* Print Styles */
@media print {
    .breadcrumb-container {
        background: white !important;
        box-shadow: none !important;
        border: 1px solid #000000 !important;
        padding: 0.5rem !important;
        margin-bottom: 1rem !important;
    }
    
    .breadcrumb-container::before,
    .breadcrumb-item.current::before {
        display: none !important;
    }
    
    .breadcrumb-link,
    .breadcrumb-item.current {
        color: #000000 !important;
        background: white !important;
        box-shadow: none !important;
    }
}

/* ===== MELHORIAS UX PROFISSIONAIS BREADCRUMB ===== */

/* Estados de Focus Aprimorados */
.breadcrumb-link:focus-visible {
    outline: 3px solid #3b82f6;
    outline-offset: 2px;
    border-radius: 10px;
    background: rgba(59, 130, 246, 0.1);
    box-shadow: 
        0 0 0 4px rgba(59, 130, 246, 0.1),
        0 4px 8px rgba(59, 130, 246, 0.15);
    transform: scale(1.02);
}

.breadcrumb-item.current:focus-within {
    outline: 3px solid #f59e0b;
    outline-offset: 2px;
    border-radius: 10px;
}

/* Indicadores de Status */
.breadcrumb-container[data-loading="true"] {
    opacity: 0.7;
    pointer-events: none;
}

.breadcrumb-container[data-loading="true"]::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 1rem;
    width: 16px;
    height: 16px;
    border: 2px solid #e5e7eb;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

/* Indicador de Página Ativa Avançado */
.breadcrumb-item.current::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 50%;
    transform: translateX(-50%);
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, #ffffff, transparent);
    border-radius: 1px;
    animation: glow 2s ease-in-out infinite alternate;
}

/* Micro-interações */
.breadcrumb-link:active {
    transform: translateY(1px) scale(0.98);
    box-shadow: 
        0 2px 4px rgba(59, 130, 246, 0.2),
        inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

/* Tooltip Nativo Melhorado */
.breadcrumb-link[title]:hover::before {
    content: attr(title);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(31, 41, 55, 0.9);
    color: white;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    font-size: 0.75rem;
    white-space: nowrap;
    z-index: 1000;
    margin-bottom: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(4px);
    animation: tooltipFadeIn 0.2s ease-out;
}

.breadcrumb-link[title]:hover::after {
    content: '';
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 4px solid transparent;
    border-top-color: rgba(31, 41, 55, 0.9);
    z-index: 1000;
}

/* Separadores Animados */
.breadcrumb-item:not(:last-child)::after {
    transition: all 0.3s ease;
}

.breadcrumb-item:hover + .breadcrumb-item::after {
    transform: scale(1.5);
    opacity: 1;
}

/* Estados de Carregamento */
.breadcrumb-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 10px;
    height: 40px;
}

/* Indicadores de Notificação */
.breadcrumb-item.has-updates::before {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    background: #ef4444;
    border-radius: 50%;
    box-shadow: 0 0 0 2px white;
    animation: pulse 2s infinite;
}

/* Keyboard Navigation Enhancement */
.breadcrumb:focus-within {
    outline: 2px solid #3b82f6;
    outline-offset: 4px;
    border-radius: 16px;
}

/* Estado de Sucesso para Navegação */
.breadcrumb-container.success {
    border-color: #10b981;
    background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%);
}

.breadcrumb-container.success::before {
    background: linear-gradient(90deg, #10b981, #059669);
}

/* Animações UX Adicionais */
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

@keyframes glow {
    from {
        opacity: 0.5;
        box-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
    }
    to {
        opacity: 1;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
    }
}

@keyframes tooltipFadeIn {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(5px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes loading {
    0% {
        background-position: -200% 0;
    }
    100% {
        background-position: 200% 0;
    }
}

/* Melhoria de Performance */
.breadcrumb-container,
.breadcrumb-link,
.breadcrumb-item.current {
    will-change: transform, opacity, box-shadow;
    contain: layout style paint;
}

/* Otimização para Toque */
@media (hover: none) and (pointer: coarse) {
    .breadcrumb-link {
        min-height: 44px;
        min-width: 44px;
        padding: 0.75rem 1rem;
    }
    
    .breadcrumb-item.current {
        min-height: 44px;
        padding: 0.75rem 1rem;
    }
    
    .breadcrumb-link:hover {
        transform: none;
        scale: 1;
    }
    
    .breadcrumb-link[title]:hover::before,
    .breadcrumb-link[title]:hover::after {
        display: none;
    }
}

/* Otimização para Dispositivos com Tela de Alta Densidade */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .breadcrumb-container::before {
        height: 1px;
        background-size: 100% 1px;
    }
    
    .breadcrumb-item:not(:last-child)::after {
        width: 3px;
        height: 3px;
    }
}

/* Melhorias para Leitores de Tela */
.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}
</style>

<script>
// Funções JavaScript melhoradas
function limparFiltros() {
    document.getElementById('filtrosForm').reset();
    window.location.href = window.location.pathname;
}

function aplicarFiltros() {
    document.getElementById('filtrosForm').submit();
}

function toggleExportOptions() {
    const exportOptions = document.getElementById('exportOptions');
    const toggleIcon = document.querySelector('.export-toggle-icon i');
    
    if (exportOptions.style.display === 'none' || exportOptions.style.display === '') {
        exportOptions.style.display = 'block';
        toggleIcon.style.transform = 'rotate(180deg)';
    } else {
        exportOptions.style.display = 'none';
        toggleIcon.style.transform = 'rotate(0deg)';
    }
}

function exportarPDF() {
    showToast('Exportando relatório em PDF...', 'info');
    toggleExportOptions();
    
    // Construir URL com filtros atuais
    const params = new URLSearchParams();
    
    // Pegar valores dos filtros
    const busca = document.querySelector('input[name="busca"]')?.value;
    const tipo = document.querySelector('select[name="tipo"]')?.value;
    const status = document.querySelector('select[name="status"]')?.value;
    const dataInicio = document.querySelector('input[name="data_inicio"]')?.value;
    const dataFim = document.querySelector('input[name="data_fim"]')?.value;
    
    // Adicionar parâmetros apenas se tiverem valor válido
    if (busca && busca.trim() && busca !== 'None') params.append('busca', busca);
    if (tipo && tipo !== 'None' && tipo !== '') params.append('tipo', tipo);
    if (status && status !== 'None' && status !== '') params.append('status', status);
    if (dataInicio && dataInicio !== 'None' && dataInicio !== '') params.append('data_inicio', dataInicio);
    if (dataFim && dataFim !== 'None' && dataFim !== '') params.append('data_fim', dataFim);
    
    // Redirecionar para URL de exportação PDF
    const url = '{% url "export_historico_pdf" %}' + (params.toString() ? '?' + params.toString() : '');
    window.location.href = url;
}

function exportarExcel() {
    showToast('Exportando relatório em Excel...', 'info');
    toggleExportOptions();
    
    // Construir URL com filtros atuais
    const params = new URLSearchParams();
    
    // Pegar valores dos filtros
    const busca = document.querySelector('input[name="busca"]')?.value;
    const tipo = document.querySelector('select[name="tipo"]')?.value;
    const status = document.querySelector('select[name="status"]')?.value;
    const dataInicio = document.querySelector('input[name="data_inicio"]')?.value;
    const dataFim = document.querySelector('input[name="data_fim"]')?.value;
    
    // Adicionar parâmetros apenas se tiverem valor válido
    if (busca && busca.trim() && busca !== 'None') params.append('busca', busca);
    if (tipo && tipo !== 'None' && tipo !== '') params.append('tipo', tipo);
    if (status && status !== 'None' && status !== '') params.append('status', status);
    if (dataInicio && dataInicio !== 'None' && dataInicio !== '') params.append('data_inicio', dataInicio);
    if (dataFim && dataFim !== 'None' && dataFim !== '') params.append('data_fim', dataFim);
    
    // Redirecionar para URL de exportação Excel
    const url = '{% url "export_historico_excel" %}' + (params.toString() ? '?' + params.toString() : '');
    window.location.href = url;
}

function verDetalhes(id) {
    const chamadaId = parseInt(id);
    
    // Abrir modal de detalhes
    const modal = new bootstrap.Modal(document.getElementById('detalhesModal'));
    modal.show();
    
    // Verificar se temos dados atualizados em cache
    if (chamadaCache.has(chamadaId)) {
        console.log('📋 Usando dados do cache para chamada:', chamadaId);
        const dadosCache = chamadaCache.get(chamadaId);
        renderDetalhes(dadosCache);
        
        // Ainda assim, fazer uma requisição para garantir dados mais frescos
        // mas sem bloquear a renderização inicial
        atualizarDetalhesViaAjax(id, true);
    } else {
        console.log('🔄 Carregando dados via AJAX para chamada:', chamadaId);
        atualizarDetalhesViaAjax(id, false);
    }
}

function atualizarDetalhesViaAjax(id, isBackgroundUpdate = false) {
    fetch(`/accounts/chamada/${id}/detalhes/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Atualizar cache com dados frescos do servidor
            chamadaCache.set(parseInt(id), data.data);
            
            // Se não é uma atualização em background, renderizar imediatamente
            if (!isBackgroundUpdate) {
                renderDetalhes(data.data);
            } else {
                // Em background, apenas atualizar se houve mudanças significativas
                const dadosAtuais = chamadaCache.get(parseInt(id));
                if (JSON.stringify(dadosAtuais) !== JSON.stringify(data.data)) {
                    console.log('🔄 Dados atualizados detectados, re-renderizando detalhes');
                    renderDetalhes(data.data);
                    mostrarIndicadorAtualizacao();
                }
            }
        } else {
            if (!isBackgroundUpdate) {
                showToast(data.message || 'Erro ao carregar detalhes', 'error');
            }
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        if (!isBackgroundUpdate) {
            showToast('Erro ao carregar detalhes da chamada', 'error');
        }
    });
}

function mostrarIndicadorAtualizacao() {
    // Criar um pequeno indicador visual de que os dados foram atualizados
    const header = document.querySelector('.modal-header-detalhes');
    if (!header) return;
    
    const indicator = document.createElement('div');
    indicator.className = 'update-indicator';
    indicator.innerHTML = '<i class="fas fa-sync-alt"></i> Atualizado';
    indicator.style.cssText = `
        position: absolute;
        top: 10px;
        right: 60px;
        background: #22c55e;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        z-index: 1001;
        animation: slideInRight 0.5s ease, fadeOut 0.5s ease 2s forwards;
    `;
    
    header.appendChild(indicator);
    
    // Remover após 3 segundos
    setTimeout(() => {
        if (indicator && indicator.parentNode) {
            indicator.parentNode.removeChild(indicator);
        }
    }, 3000);
}

function editarChamada(id) {
    // Abrir modal de edição
    const modal = new bootstrap.Modal(document.getElementById('editarModal'));
    modal.show();
    
    // Carregar dados via AJAX
    fetch(`/accounts/chamada/${id}/editar-form/`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCsrfToken()
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            renderFormularioEdicao(data.data);
        } else {
            showToast(data.message || 'Erro ao carregar formulário', 'error');
        }
    })
    .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao carregar formulário de edição', 'error');
    });
}

function renderDetalhes(data, camposAlterados = []) {
    const content = document.getElementById('detalhesContent');
    
    // Verificar se há dados anteriores para comparação
    const dadosAnteriores = content.dataset.ultimosDados ? JSON.parse(content.dataset.ultimosDados) : null;
    
    content.innerHTML = `
        <div class="detalhes-grid">
            <div class="detalhe-item ${isFieldChanged('codigo', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-hashtag" style="color: #10b981;"></i>
                    Código da Chamada
                    ${isFieldChanged('codigo', data, dadosAnteriores) ? '<span class="update-badge">NOVO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.codigo}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('nome_contato', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-user" style="color: #10b981;"></i>
                    Nome do Contato
                    ${isFieldChanged('nome_contato', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.nome_contato}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('telefone', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-phone" style="color: #10b981;"></i>
                    Telefone
                    ${isFieldChanged('telefone', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">
                    <a href="tel:${data.telefone}" style="color: #10b981; text-decoration: none;">
                        ${data.telefone}
                    </a>
                </div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('funcao', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-briefcase" style="color: #10b981;"></i>
                    Função/Cargo
                    ${isFieldChanged('funcao', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.funcao || 'Não informado'}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('setor', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-building" style="color: #10b981;"></i>
                    Setor de Atuação
                    ${isFieldChanged('setor', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.setor || 'Não informado'}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('unidade', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-hospital" style="color: #10b981;"></i>
                    Nome da Unidade
                    ${isFieldChanged('unidade', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.unidade}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('municipio', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-map-marker-alt" style="color: #10b981;"></i>
                    Município
                    ${isFieldChanged('municipio', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.municipio || 'Não informado'}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('cnes', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-id-card" style="color: #10b981;"></i>
                    Código CNES
                    ${isFieldChanged('cnes', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.cnes || 'Não informado'}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('contato_telefonico_cnes', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-phone-alt" style="color: #10b981;"></i>
                    Contato Telefônico CNES
                    ${isFieldChanged('contato_telefonico_cnes', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.contato_telefonico_cnes || 'Não informado'}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('tipo_chamada', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-tag" style="color: #10b981;"></i>
                    Tipo de Chamada
                    ${isFieldChanged('tipo_chamada', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.tipo_chamada}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('status', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-flag" style="color: #10b981;"></i>
                    Status
                    ${isFieldChanged('status', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.status}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('nome_atendente', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-user-tie" style="color: #10b981;"></i>
                    Nome do Atendente
                    ${isFieldChanged('nome_atendente', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.nome_atendente}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('descricao', data, dadosAnteriores) ? 'field-updated' : ''}" style="grid-column: 1 / -1;">
                <div class="detalhe-label">
                    <i class="fas fa-comment-alt" style="color: #10b981;"></i>
                    Descrição da Solicitação
                    ${isFieldChanged('descricao', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor" style="white-space: pre-wrap;">${data.descricao}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('solucao', data, dadosAnteriores) ? 'field-updated' : ''}" style="grid-column: 1 / -1;">
                <div class="detalhe-label">
                    <i class="fas fa-check-circle" style="color: #10b981;"></i>
                    Solução/Encaminhamento
                    ${isFieldChanged('solucao', data, dadosAnteriores) ? '<span class="update-badge">ATUALIZADO</span>' : ''}
                </div>
                <div class="detalhe-valor" style="white-space: pre-wrap;">${data.solucao || 'Não informado'}</div>
            </div>
            
            <div class="detalhe-item">
                <div class="detalhe-label">
                    <i class="fas fa-calendar-plus" style="color: #10b981;"></i>
                    Data de Criação
                </div>
                <div class="detalhe-valor">${data.data_criacao}</div>
            </div>
            
            <div class="detalhe-item ${isFieldChanged('data_atualizacao', data, dadosAnteriores) ? 'field-updated' : ''}">
                <div class="detalhe-label">
                    <i class="fas fa-calendar-check" style="color: #10b981;"></i>
                    Última Atualização
                    ${isFieldChanged('data_atualizacao', data, dadosAnteriores) ? '<span class="update-badge">RECENTE</span>' : ''}
                </div>
                <div class="detalhe-valor">${data.data_atualizacao}</div>
            </div>
            
            <div class="detalhe-item">
                <div class="detalhe-label">
                    <i class="fas fa-user-edit" style="color: #10b981;"></i>
                    Usuário Criador
                </div>
                <div class="detalhe-valor">${data.usuario_criador}</div>
            </div>
        </div>
    `;
    
    // Armazenar dados atuais para próxima comparação
    content.dataset.ultimosDados = JSON.stringify(data);
    
    // Aplicar animação aos campos atualizados
    setTimeout(() => {
        const camposAtualizados = content.querySelectorAll('.field-updated');
        camposAtualizados.forEach((campo, index) => {
            setTimeout(() => {
                campo.style.animation = 'fieldUpdateHighlight 2s ease';
                setTimeout(() => {
                    campo.classList.remove('field-updated');
                    campo.style.animation = '';
                }, 2000);
            }, index * 200);
        });
    }, 100);
}

function isFieldChanged(fieldName, dadosNovos, dadosAnteriores) {
    if (!dadosAnteriores) return false;
    return dadosNovos[fieldName] !== dadosAnteriores[fieldName];
}

function renderFormularioEdicao(data) {
    const content = document.getElementById('editarContent');
    content.innerHTML = `
        <form id="formEditarChamada" data-chamada-id="${data.id}">
            <div class="edicao-sections">
                
                <!-- Seção 1: Dados Pessoais -->
                <div class="edicao-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Dados Pessoais</h3>
                            <p class="section-description">Informações de contato e identificação do solicitante</p>
                        </div>
                    </div>
                    
                    <div class="edicao-grid">
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-user" style="color: #10b981;"></i>
                                Nome do Contato
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input campo-destacado" name="nome_contato" 
                                       value="${data.nome_contato}" required placeholder="Digite o nome completo">
                                <i class="fas fa-check-circle validation-icon success"></i>
                            </div>
                            <small class="help-text">Nome completo da pessoa que fez a solicitação</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-phone" style="color: #10b981;"></i>
                                Telefone
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <input type="tel" class="edicao-input campo-destacado" name="telefone" 
                                       value="${data.telefone}" required placeholder="(00) 00000-0000">
                                <i class="fas fa-check-circle validation-icon success"></i>
                            </div>
                            <small class="help-text">Número com DDD para contato direto</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-briefcase" style="color: #10b981;"></i>
                                Função/Cargo
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input" name="funcao" 
                                       value="${data.funcao}" placeholder="Ex: Enfermeiro, Médico, Técnico">
                            </div>
                            <small class="help-text">Cargo ou função exercida na unidade</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-building" style="color: #10b981;"></i>
                                Setor de Atuação
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input" name="setor" 
                                       value="${data.setor}" placeholder="Ex: UTI, Emergência, Pediatria">
                            </div>
                            <small class="help-text">Departamento ou setor onde trabalha</small>
                        </div>
                    </div>
                </div>
                
                <!-- Seção 2: Dados da Unidade -->
                <div class="edicao-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-hospital"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Dados da Unidade de Saúde</h3>
                            <p class="section-description">Informações sobre a instituição de saúde</p>
                        </div>
                    </div>
                    
                    <div class="edicao-grid">
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-hospital" style="color: #10b981;"></i>
                                Nome da Unidade
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input campo-destacado" name="unidade" 
                                       value="${data.unidade}" required placeholder="Nome completo da unidade">
                                <i class="fas fa-check-circle validation-icon success"></i>
                            </div>
                            <small class="help-text">Nome oficial da unidade de saúde</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-map-marker-alt" style="color: #10b981;"></i>
                                Município
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input" name="municipio" 
                                       value="${data.municipio}" placeholder="Cidade onde está localizada">
                            </div>
                            <small class="help-text">Município de localização da unidade</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-id-card" style="color: #10b981;"></i>
                                Código CNES
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input" name="cnes" 
                                       value="${data.cnes}" placeholder="0000000" maxlength="7">
                                <span class="char-counter" data-max="7">0/7</span>
                            </div>
                            <small class="help-text">Cadastro Nacional de Estabelecimentos de Saúde</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-phone-alt" style="color: #10b981;"></i>
                                Contato Telefônico CNES
                            </label>
                            <div class="input-container">
                                <input type="tel" class="edicao-input" name="contato_telefonico_cnes" 
                                       value="${data.contato_telefonico_cnes}" placeholder="(00) 0000-0000">
                            </div>
                            <small class="help-text">Telefone principal da unidade de saúde</small>
                        </div>
                    </div>
                </div>
                
                <!-- Seção 3: Dados da Chamada -->
                <div class="edicao-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Dados da Chamada</h3>
                            <p class="section-description">Classificação e responsável pelo atendimento</p>
                        </div>
                    </div>
                    
                    <div class="edicao-grid">
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-tag" style="color: #10b981;"></i>
                                Tipo de Chamada
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <select class="edicao-input edicao-select campo-destacado" name="tipo_chamada" required>
                                    <option value="">Selecione o tipo de chamada</option>
                                    <option value="cadastro_unidade" ${data.tipo_chamada === 'cadastro_unidade' ? 'selected' : ''}>Cadastro de Unidade</option>
                                    <option value="atualizacao_dados" ${data.tipo_chamada === 'atualizacao_dados' ? 'selected' : ''}>Atualização de Dados</option>
                                    <option value="suporte_tecnico" ${data.tipo_chamada === 'suporte_tecnico' ? 'selected' : ''}>Suporte Técnico</option>
                                    <option value="outros" ${data.tipo_chamada === 'outros' ? 'selected' : ''}>Outros</option>
                                </select>
                                <i class="fas fa-check-circle validation-icon success"></i>
                            </div>
                            <small class="help-text">Categoria da solicitação realizada</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-flag" style="color: #10b981;"></i>
                                Status
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <select class="edicao-input edicao-select campo-destacado" name="status" required>
                                    <option value="">Selecione o status</option>
                                    <option value="pendente" ${data.status === 'pendente' ? 'selected' : ''}>Pendente</option>
                                    <option value="em_andamento" ${data.status === 'em_andamento' ? 'selected' : ''}>Em Andamento</option>
                                    <option value="resolvido" ${data.status === 'resolvido' ? 'selected' : ''}>Resolvido</option>
                                    <option value="cancelado" ${data.status === 'cancelado' ? 'selected' : ''}>Cancelado</option>
                                </select>
                                <i class="fas fa-check-circle validation-icon success"></i>
                            </div>
                            <small class="help-text">Situação atual da solicitação</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-user-tie" style="color: #10b981;"></i>
                                Nome do Atendente
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <input type="text" class="edicao-input campo-destacado" name="nome_atendente" 
                                       value="${data.nome_atendente}" required placeholder="Nome do responsável">
                                <i class="fas fa-check-circle validation-icon success"></i>
                            </div>
                            <small class="help-text">Funcionário responsável pelo atendimento</small>
                        </div>
                    </div>
                </div>
                
                <!-- Seção 4: Descrição e Solução -->
                <div class="edicao-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div>
                            <h3 class="section-title">Descrição e Solução</h3>
                            <p class="section-description">Detalhes da solicitação e encaminhamentos</p>
                        </div>
                    </div>
                    
                    <div class="edicao-grid">
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-comment-alt" style="color: #10b981;"></i>
                                Descrição da Solicitação
                                <span class="required-indicator">*</span>
                            </label>
                            <div class="input-container">
                                <textarea class="edicao-input edicao-textarea campo-destacado" name="descricao" 
                                          required placeholder="Descreva detalhadamente a solicitação...">${data.descricao}</textarea>
                                <span class="char-counter" data-max="1000">${data.descricao.length}/1000</span>
                            </div>
                            <small class="help-text">Descrição completa do que foi solicitado</small>
                        </div>
                        
                        <div class="edicao-item">
                            <label class="edicao-label">
                                <i class="fas fa-check-circle" style="color: #10b981;"></i>
                                Solução/Encaminhamento
                            </label>
                            <div class="input-container">
                                <textarea class="edicao-input edicao-textarea" name="solucao" 
                                          placeholder="Descreva a solução ou encaminhamento dado...">${data.solucao}</textarea>
                                <span class="char-counter" data-max="1000">${data.solucao ? data.solucao.length : 0}/1000</span>
                            </div>
                            <small class="help-text">Solução aplicada ou encaminhamento realizado</small>
                        </div>
                    </div>
                </div>
                
            </div>
        </form>
    `;
    
    // Adicionar funcionalidades dinâmicas
    adicionarValidacaoTempo();
    adicionarContadorCaracteres();
    adicionarMascaraTelefone();
}

// Cache para dados das chamadas
const chamadaCache = new Map();

function salvarChamada() {
    console.log('🚀 Iniciando processo de salvamento da chamada');
    
    const form = document.getElementById('formEditarChamada');
    const btnSalvar = document.getElementById('btnSalvarChamada');
    
    if (!form) {
        console.error('❌ Formulário de edição não encontrado');
        showToast('Erro: Formulário não encontrado', 'error');
        return;
    }
    
    if (!btnSalvar) {
        console.error('❌ Botão salvar não encontrado');
        showToast('Erro: Botão de salvamento não encontrado', 'error');
        return;
    }
    
    // Validar formulário antes de enviar
    console.log('🔍 Validando formulário...');
    if (!validarFormularioCompleto()) {
        console.warn('⚠️ Formulário contém erros de validação');
        showToast('Por favor, corrija os erros no formulário antes de salvar', 'error');
        return;
    }
    
    console.log('✅ Formulário validado com sucesso');
    
    // Desabilitar botão durante o salvamento
    console.log('🔒 Desabilitando botão e aplicando efeitos visuais');
    btnSalvar.disabled = true;
    btnSalvar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
    
    // Adicionar efeito visual de carregamento
    document.querySelector('.modal-content').classList.add('saving');
    
    const formData = new FormData(form);
    const chamadaId = form.dataset.chamadaId;
    
    console.log('📋 Chamada ID:', chamadaId);
    
    // Converter FormData para objeto JSON
    const data = {
        id: chamadaId,
        nome_contato: formData.get('nome_contato').trim(),
        telefone: formData.get('telefone').trim(),
        funcao: formData.get('funcao').trim(),
        setor: formData.get('setor').trim(),
        unidade: formData.get('unidade').trim(),
        municipio: formData.get('municipio').trim(),
        cnes: formData.get('cnes').trim(),
        contato_telefonico_cnes: formData.get('contato_telefonico_cnes').trim(),
        tipo_chamada: formData.get('tipo_chamada'),
        status: formData.get('status'),
        nome_atendente: formData.get('nome_atendente').trim(),
        descricao: formData.get('descricao').trim(),
        solucao: formData.get('solucao').trim()
    };
    
    console.log('📦 Dados preparados para envio:', data);
    console.log('🌐 Enviando requisição para:', '/accounts/api/editar-chamada/');
    
    fetch('/accounts/api/editar-chamada/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('📡 Resposta recebida:', response.status, response.statusText);
        return response.json();
    })
    .then(result => {
        console.log('📄 Resultado da API:', result);
        
        if (result.success) {
            console.log('✅ Salvamento realizado com sucesso!');
            
            // Animação de sucesso
            document.querySelector('.modal-content').classList.add('success');
            
            // Atualizar dados em tempo real
            console.log('🔄 Atualizando dados em tempo real...');
            atualizarDadosTempoReal(chamadaId, data);
            
            // Mostrar mensagem de sucesso mais prominente
            console.log('🎉 Exibindo mensagem de sucesso...');
            mostrarMensagemSucessoSalvamento();
            
            // Fechar modal e redirecionar após delay
            console.log('⏱️ Agendando fechamento do modal e redirecionamento...');
            setTimeout(() => {
                console.log('🚪 Fechando modal...');
                const modal = bootstrap.Modal.getInstance(document.getElementById('editarModal'));
                if (modal) {
                    modal.hide();
                }
                
                // Redirecionar para a página de histórico após fechar o modal
                setTimeout(() => {
                    console.log('🔄 Redirecionando para página de histórico...');
                    window.location.href = '/accounts/historico/';
                }, 500);
            }, 2000); // Aumentar delay para dar tempo de ver a mensagem
        } else {
            console.error('❌ Erro retornado pela API:', result.message);
            showToast(result.message || 'Erro ao salvar alterações', 'error');
        }
    })
    .catch(error => {
        console.error('❌ Erro ao salvar chamada:', error);
        
        // Remover animação de sucesso se houver
        document.querySelector('.modal-content').classList.remove('success');
        
        // Mostrar erro detalhado
        showToast('Erro ao salvar alterações. Tente novamente.', 'error');
        
        // Log detalhado para debug
        console.error('Detalhes do erro:', {
            message: error.message,
            stack: error.stack,
            chamadaId: chamadaId,
            dadosEnviados: data
        });
    })
    .finally(() => {
        // Remover classes de carregamento
        const modalContent = document.querySelector('.modal-content');
        if (modalContent) {
            modalContent.classList.remove('saving');
        }
        
        // Reabilitar botão sempre, mesmo em caso de erro
        if (btnSalvar) {
            btnSalvar.disabled = false;
            btnSalvar.innerHTML = '<i class="fas fa-save"></i> Salvar Alterações';
        }
        
        console.log('🔄 Processo de salvamento finalizado');
    });
}

function atualizarDadosTempoReal(chamadaId, dadosAtualizados) {
    // Atualizar cache com os novos dados
    const dadosCompletos = {
        id: parseInt(chamadaId),
        codigo: `#${String(chamadaId).padStart(4, '0')}`,
        nome_contato: dadosAtualizados.nome_contato,
        telefone: dadosAtualizados.telefone,
        funcao: dadosAtualizados.funcao || 'Não informado',
        setor: dadosAtualizados.setor || 'Não informado',
        unidade: dadosAtualizados.unidade,
        municipio: dadosAtualizados.municipio || 'Não informado',
        cnes: dadosAtualizados.cnes || 'Não informado',
        contato_telefonico_cnes: dadosAtualizados.contato_telefonico_cnes || 'Não informado',
        tipo_chamada: getTipoDisplayName(dadosAtualizados.tipo_chamada),
        status: getStatusDisplayName(dadosAtualizados.status),
        nome_atendente: dadosAtualizados.nome_atendente,
        descricao: dadosAtualizados.descricao,
        solucao: dadosAtualizados.solucao || 'Não informado',
        data_criacao: new Date().toLocaleDateString('pt-BR') + ' às ' + new Date().toLocaleTimeString('pt-BR'),
        data_atualizacao: new Date().toLocaleDateString('pt-BR') + ' às ' + new Date().toLocaleTimeString('pt-BR'),
        usuario_criador: document.querySelector('.user-name')?.textContent || 'Usuário',
        dias_desde_criacao: 0
    };
    
    // Armazenar no cache para uso posterior
    chamadaCache.set(parseInt(chamadaId), dadosCompletos);
    
    // Atualizar a linha da tabela se existir
    atualizarLinhaTabela(chamadaId, dadosAtualizados);
    
    // Criar evento personalizado para notificar outros componentes
    const evento = new CustomEvent('chamadaAtualizada', {
        detail: { chamadaId: parseInt(chamadaId), dados: dadosCompletos }
    });
    document.dispatchEvent(evento);
    
    console.log('✅ Dados atualizados em tempo real para chamada:', chamadaId);
}

function atualizarLinhaTabela(chamadaId, dados) {
    // Encontrar a linha da tabela correspondente
    const linhas = document.querySelectorAll('.registro-row');
    let linhaAtualizada = null;
    
    linhas.forEach(linha => {
        const btnEditar = linha.querySelector('.btn-editar');
        if (btnEditar && btnEditar.getAttribute('onclick').includes(chamadaId)) {
            linhaAtualizada = linha;
        }
    });
    
    if (!linhaAtualizada) return;
    
    // Atualizar células específicas da tabela
    try {
        // Nome do contato
        const cellContato = linhaAtualizada.querySelector('.solicitante-info .nome');
        if (cellContato) {
            cellContato.textContent = dados.nome_contato;
        }
        
        // Função
        const cellFuncao = linhaAtualizada.querySelector('.solicitante-info .funcao');
        if (cellFuncao) {
            cellFuncao.textContent = dados.funcao || 'Não informado';
        }
        
        // Telefone
        const cellTelefone = linhaAtualizada.querySelector('.telefone-link-simple');
        if (cellTelefone) {
            cellTelefone.textContent = dados.telefone;
            cellTelefone.href = `tel:${dados.telefone}`;
        }
        
        // Unidade
        const cellUnidade = linhaAtualizada.querySelector('.unidade-info .nome-unidade');
        if (cellUnidade) {
            cellUnidade.textContent = dados.unidade;
        }
        
        // Município
        const cellMunicipio = linhaAtualizada.querySelector('.unidade-info .municipio');
        if (cellMunicipio) {
            cellMunicipio.textContent = dados.municipio || 'Não informado';
        }
        
        // Tipo de chamada
        const cellTipo = linhaAtualizada.querySelector('.tipo-badge');
        if (cellTipo) {
            cellTipo.textContent = getTipoDisplayName(dados.tipo_chamada);
        }
        
        // Adicionar efeito visual de atualização
        linhaAtualizada.style.animation = 'updateHighlight 2s ease';
        setTimeout(() => {
            linhaAtualizada.style.animation = '';
        }, 2000);
        
    } catch (error) {
        console.warn('Erro ao atualizar linha da tabela:', error);
    }
}

function getTipoDisplayName(tipo) {
    const tipos = {
        'cadastro_unidade': 'Cadastro de Unidade',
        'atualizacao_dados': 'Atualização de Dados',
        'suporte_tecnico': 'Suporte Técnico',
        'outros': 'Outros'
    };
    return tipos[tipo] || tipo;
}

function getStatusDisplayName(status) {
    const statuses = {
        'pendente': 'Pendente',
        'em_andamento': 'Em Andamento',
        'resolvido': 'Resolvido',
        'cancelado': 'Cancelado'
    };
    return statuses[status] || status;
}

function validarFormularioCompleto() {
    const inputs = document.querySelectorAll('.edicao-input');
    let isValid = true;
    
    inputs.forEach(input => {
        if (!validarCampo(input)) {
            isValid = false;
        }
    });
    
    // Destacar seções com erros
    const sections = document.querySelectorAll('.edicao-section');
    sections.forEach(section => {
        const hasErrors = section.querySelector('.input-error, .input-warning');
        if (hasErrors) {
            section.classList.add('section-error');
            setTimeout(() => {
                section.classList.remove('section-error');
            }, 3000);
        }
    });
    
    return isValid;
}

function resetarFormulario() {
    const form = document.getElementById('formEditarChamada');
    if (form) {
        form.reset();
        showToast('Formulário resetado', 'info');
    }
}

 function imprimirDetalhes() {
    const detalhesContent = document.getElementById('detalhesContent').innerHTML;
     const printWindow = window.open('', '_blank');
     printWindow.document.write(`
         <html>
         <head>
             <title>Detalhes da Chamada</title>
             <style>
                 body { font-family: Arial, sans-serif; margin: 20px; }
                    .detalhes-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
                    .detalhe-item { padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                    .detalhe-label { font-weight: bold; margin-bottom: 10px; }
                    .detalhe-valor { color: #666; }
                 @media print { body { margin: 0; } }
             </style>
         </head>
         <body>
             <h1>Detalhes da Chamada</h1>
                ${detalhesContent}
         </body>
         </html>
     `);
     printWindow.document.close();
     printWindow.print();
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// Funcionalidades dinâmicas do formulário
function adicionarValidacaoTempo() {
    const inputs = document.querySelectorAll('.edicao-input');
    
    inputs.forEach(input => {
        // Validação em tempo real
        input.addEventListener('input', function() {
            validarCampo(this);
        });
        
        // Efeitos visuais no foco
        input.addEventListener('focus', function() {
            this.closest('.edicao-item').classList.add('focused');
        });
        
        input.addEventListener('blur', function() {
            this.closest('.edicao-item').classList.remove('focused');
            validarCampo(this);
        });
    });
}

function validarCampo(campo) {
    const container = campo.closest('.input-container');
    const validationIcon = container?.querySelector('.validation-icon');
    const helpText = campo.closest('.edicao-item')?.querySelector('.help-text');
    
    // Remover classes anteriores
    campo.classList.remove('input-success', 'input-error', 'input-warning');
    if (validationIcon) {
        validationIcon.classList.remove('success', 'error', 'warning');
    }
    
    // Validações específicas
    if (campo.hasAttribute('required') && !campo.value.trim()) {
        campo.classList.add('input-error');
        if (validationIcon) {
            validationIcon.classList.add('error');
            validationIcon.className = validationIcon.className.replace('fa-check-circle', 'fa-exclamation-circle');
        }
        if (helpText) {
            helpText.textContent = 'Este campo é obrigatório';
            helpText.classList.add('error');
        }
        return false;
    }
    
    // Validação de telefone
    if (campo.type === 'tel' && campo.value) {
        const telefone = campo.value.replace(/\D/g, '');
        if (telefone.length < 10 || telefone.length > 11) {
            campo.classList.add('input-warning');
            if (validationIcon) {
                validationIcon.classList.add('warning');
                validationIcon.className = validationIcon.className.replace('fa-check-circle', 'fa-exclamation-triangle');
            }
            if (helpText) {
                helpText.textContent = 'Telefone deve ter 10 ou 11 dígitos';
                helpText.classList.add('error');
            }
            return false;
        }
    }
    
    // Validação de CNES
    if (campo.name === 'cnes' && campo.value) {
        if (campo.value.length !== 7) {
            campo.classList.add('input-warning');
            if (validationIcon) {
                validationIcon.classList.add('warning');
                validationIcon.className = validationIcon.className.replace('fa-check-circle', 'fa-exclamation-triangle');
            }
            if (helpText) {
                helpText.textContent = 'CNES deve ter exatamente 7 dígitos';
                helpText.classList.add('error');
            }
            return false;
        }
    }
    
    // Campo válido
    if (campo.value.trim()) {
        campo.classList.add('input-success');
        if (validationIcon) {
            validationIcon.classList.add('success');
            validationIcon.className = validationIcon.className.replace(/fa-exclamation-\w+/, 'fa-check-circle');
        }
        if (helpText) {
            helpText.classList.remove('error');
            // Restaurar texto original baseado no campo
            const textoOriginal = getTextoAjudaOriginal(campo.name);
            helpText.textContent = textoOriginal;
        }
    }
    
    return true;
}

function getTextoAjudaOriginal(nomeCampo) {
    const textos = {
        'nome_contato': 'Nome completo da pessoa que fez a solicitação',
        'telefone': 'Número com DDD para contato direto',
        'funcao': 'Cargo ou função exercida na unidade',
        'setor': 'Departamento ou setor onde trabalha',
        'unidade': 'Nome oficial da unidade de saúde',
        'municipio': 'Município de localização da unidade',
        'cnes': 'Cadastro Nacional de Estabelecimentos de Saúde',
        'contato_telefonico_cnes': 'Telefone principal da unidade de saúde',
        'tipo_chamada': 'Categoria da solicitação realizada',
        'status': 'Situação atual da solicitação',
        'nome_atendente': 'Funcionário responsável pelo atendimento',
        'descricao': 'Descrição completa do que foi solicitado',
        'solucao': 'Solução aplicada ou encaminhamento realizado'
    };
    return textos[nomeCampo] || '';
}

function adicionarContadorCaracteres() {
    const contadores = document.querySelectorAll('.char-counter');
    
    contadores.forEach(contador => {
        const input = contador.closest('.input-container')?.querySelector('input, textarea');
        if (!input) return;
        
        const maxLength = parseInt(contador.dataset.max);
        
        // Atualizar contador inicial
        atualizarContador(input, contador, maxLength);
        
        // Listener para atualização em tempo real
        input.addEventListener('input', function() {
            atualizarContador(this, contador, maxLength);
        });
    });
}

function atualizarContador(input, contador, maxLength) {
    const currentLength = input.value.length;
    contador.textContent = `${currentLength}/${maxLength}`;
    
    // Aplicar classes de aviso
    contador.classList.remove('warning', 'danger');
    if (currentLength > maxLength * 0.8) {
        contador.classList.add('warning');
    }
    if (currentLength > maxLength * 0.95) {
        contador.classList.add('danger');
    }
}

function adicionarMascaraTelefone() {
    const telefones = document.querySelectorAll('input[type="tel"]');
    
    telefones.forEach(telefone => {
        telefone.addEventListener('input', function(e) {
            aplicarMascaraTelefone(e.target);
        });
    });
}

function aplicarMascaraTelefone(input) {
    let valor = input.value.replace(/\D/g, '');
    
    if (valor.length <= 11) {
        if (valor.length <= 2) {
            valor = valor.replace(/(\d{0,2})/, '($1');
        } else if (valor.length <= 6) {
            valor = valor.replace(/(\d{2})(\d{0,4})/, '($1) $2');
        } else if (valor.length <= 10) {
            valor = valor.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
        } else {
            valor = valor.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
        }
    }
    
    input.value = valor;
}

function mostrarMensagemSucessoSalvamento() {
    // Criar overlay de sucesso
    const overlay = document.createElement('div');
    overlay.className = 'success-overlay';
    overlay.innerHTML = `
        <div class="success-modal">
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <h3 class="success-title">Alterações Salvas com Sucesso!</h3>
            <p class="success-message">
                Todas as alterações da chamada foram salvas no sistema.<br>
                Você será redirecionado para a página de histórico em instantes.
            </p>
            <div class="success-loading">
                <div class="loading-bar">
                    <div class="loading-progress"></div>
                </div>
                <small>Redirecionando...</small>
            </div>
        </div>
    `;
    
    // Estilos para o overlay de sucesso
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10001;
        opacity: 0;
        transition: all 0.3s ease;
    `;
    
    document.body.appendChild(overlay);
    
    // Animação de entrada
    setTimeout(() => {
        overlay.style.opacity = '1';
    }, 100);
    
    // Remover overlay após o redirecionamento
    setTimeout(() => {
        overlay.style.opacity = '0';
        setTimeout(() => {
            if (overlay.parentNode) {
                document.body.removeChild(overlay);
            }
        }, 300);
    }, 1800);
}

function showToast(message, type = 'info') {
    // Função para mostrar notificações toast
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas fa-${type === 'info' ? 'info-circle' : type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
            </div>
    `;
    
    // Estilos para o toast
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'info' ? '#3b82f6' : type === 'success' ? '#10b981' : '#ef4444'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    
    document.body.appendChild(toast);
    
    // Animação de entrada
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    // Remover após 3 segundos
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

// Sistema de eventos globais para sincronização
document.addEventListener('chamadaAtualizada', function(event) {
    const { chamadaId, dados } = event.detail;
    console.log('🔄 Evento de atualização recebido para chamada:', chamadaId);
    
    // Sincronizar todos os componentes que podem estar usando estes dados
    sincronizarComponentes(chamadaId, dados);
});

function sincronizarComponentes(chamadaId, dados) {
    // Se o modal de detalhes estiver aberto para esta chamada, atualizar
    const detalhesModal = document.getElementById('detalhesModal');
    if (detalhesModal && detalhesModal.classList.contains('show')) {
        const modalChamadaId = detalhesModal.dataset.chamadaAtual;
        if (modalChamadaId && parseInt(modalChamadaId) === chamadaId) {
            console.log('🔄 Sincronizando modal de detalhes');
            renderDetalhes(dados);
        }
    }
    
    // Atualizar estatísticas se necessário
    atualizarEstatisticas();
    
    // Emitir evento personalizado para outros componentes
    const eventoCustom = new CustomEvent('dadosSincronizados', {
        detail: { chamadaId, dados, timestamp: new Date() }
    });
    document.dispatchEvent(eventoCustom);
}

function atualizarEstatisticas() {
    // Recalcular estatísticas da página se necessário
    try {
        const totalRegistros = document.querySelectorAll('.registro-row').length;
        const estatisticaTotal = document.querySelector('.estatistica-numero');
        if (estatisticaTotal) {
            estatisticaTotal.textContent = totalRegistros;
        }
    } catch (error) {
        console.warn('Erro ao atualizar estatísticas:', error);
    }
}

// Fechar export options ao clicar fora
document.addEventListener('click', function(event) {
    const exportSection = document.querySelector('.export-section-modern');
    const exportOptions = document.getElementById('exportOptions');
    
    if (exportSection && !exportSection.contains(event.target)) {
        exportOptions.style.display = 'none';
        const toggleIcon = document.querySelector('.export-toggle-icon i');
        if (toggleIcon) {
            toggleIcon.style.transform = 'rotate(0deg)';
        }
    }
});

// Inicialização completa do sistema
document.addEventListener('DOMContentLoaded', function() {
    console.log('📋 Sistema de histórico inicializado');
    
    // Configurar eventos dos modais
    const editarModal = document.getElementById('editarModal');
    if (editarModal) {
        editarModal.addEventListener('shown.bs.modal', function() {
            console.log('📝 Modal de edição aberto');
            // Focar no primeiro campo quando abrir
            const primeiroInput = document.querySelector('#formEditarChamada input:not([readonly])');
            if (primeiroInput) {
                setTimeout(() => primeiroInput.focus(), 100);
            }
        });
        
        // Marcar qual chamada está sendo editada
        editarModal.addEventListener('show.bs.modal', function(event) {
            const botao = event.relatedTarget;
            const chamadaId = botao?.getAttribute('onclick')?.match(/\d+/)?.[0];
            if (chamadaId) {
                editarModal.dataset.chamadaAtual = chamadaId;
                console.log('📝 Editando chamada:', chamadaId);
            }
        });
    }
    
    // Configurar modal de detalhes
    const detalhesModal = document.getElementById('detalhesModal');
    if (detalhesModal) {
        detalhesModal.addEventListener('show.bs.modal', function(event) {
            const botao = event.relatedTarget;
            const chamadaId = botao?.getAttribute('onclick')?.match(/\d+/)?.[0];
            if (chamadaId) {
                detalhesModal.dataset.chamadaAtual = chamadaId;
                console.log('👁️ Visualizando chamada:', chamadaId);
            }
        });
        
        detalhesModal.addEventListener('hidden.bs.modal', function() {
            delete detalhesModal.dataset.chamadaAtual;
            console.log('👁️ Modal de detalhes fechado');
        });
    }
    
    // Listener para logs de debug
    document.addEventListener('dadosSincronizados', function(event) {
        console.log('✅ Dados sincronizados:', event.detail);
    });
    
    // Adicionar efeitos visuais nas linhas da tabela
    const rows = document.querySelectorAll('.registro-row');
    rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.1}s`;
        row.style.animation = 'fadeInUp 0.6s ease forwards';
    });
    
    console.log('🎉 Sistema de sincronização de dados ativado');
});

// CSS para animação fadeInUp
const fadeInUpCSS = `
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}
`;

// Adicionar CSS de animação
const style = document.createElement('style');
style.textContent = fadeInUpCSS;
document.head.appendChild(style);
</script>
{% endblock %} 