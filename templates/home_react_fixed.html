{% extends 'base.html' %}
{% load static %}

{% block title %}Dashboard - Sistema de Registro de Chamadas{% endblock %}

{% block extra_css %}
<style>
    body {
        margin: 0;
        padding: 0;
        overflow-x: hidden;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .home-react-container {
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .loading-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-align: center;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255,255,255,0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .error-container {
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
        border-radius: 12px;
        padding: 20px;
        margin: 20px;
        color: white;
    }

    .fallback-container {
        display: none;
        padding: 20px;
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        margin: 20px;
        color: white;
    }

    .debug-info {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 10px;
        border-radius: 8px;
        font-size: 12px;
        max-width: 300px;
        z-index: 1000;
    }
</style>
{% endblock %}

{% block content %}
<div id="home-react-root">
    <div class="loading-container">
        <div>
            <div class="loading-spinner"></div>
            <h2>Carregando Dashboard...</h2>
            <p>Inicializando componentes React</p>
        </div>
    </div>
    
    <!-- Fallback HTML -->
    <div class="fallback-container" id="fallback-content">
        <h2>üè† Dashboard - Modo Compatibilidade</h2>
        <p>Bem-vindo, {{ user.first_name|default:user.username }}!</p>
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">
            <div style="background: rgba(59, 130, 246, 0.2); padding: 20px; border-radius: 12px;">
                <h3>üìä Estat√≠sticas</h3>
                <p>Unidades: {{ estatisticas.total_unidades|default:0 }}</p>
                <p>Chamadas: {{ estatisticas.total_chamadas|default:0 }}</p>
                <p>Hoje: {{ estatisticas.chamadas_hoje|default:0 }}</p>
            </div>
            
            <div style="background: rgba(16, 185, 129, 0.2); padding: 20px; border-radius: 12px;">
                <h3>üöÄ Acesso R√°pido</h3>
                <p><a href="/accounts/unidades-saude/" style="color: white;">Unidades de Sa√∫de</a></p>
                <p><a href="/accounts/registro-chamada/" style="color: white;">Registro de Chamadas</a></p>
                <p><a href="/accounts/lista-telefonica/" style="color: white;">Lista Telef√¥nica</a></p>
            </div>
        </div>
        
        <button onclick="tryLoadReact()" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
            üîÑ Tentar Carregar React Novamente
        </button>
    </div>
</div>

<!-- Debug Info -->
<div class="debug-info" id="debug-info" style="display: none;">
    <strong>Debug Info:</strong><br>
    <span id="debug-content">Carregando...</span>
</div>

<!-- Scripts essenciais -->
<!-- React CDN -->
<!-- Scripts removidos do CDN, agora React √© carregado via include central ou arquivos locais -->

<!-- Script de diagn√≥stico -->
<script src="{% static 'debug_home_dashboard.js' %}"></script>

<!-- Componente HomeReact -->
<script src="{% static 'js/components/HomeReact.js' %}"></script>

<script>
// Configura√ß√£o global
window.REACT_CONFIG = {
    user: {
        id: {{ user.id|default:'null' }},
        username: '{{ user.username|default:'' }}',
        first_name: '{{ user.first_name|default:user.username }}'
    },
    csrf_token: '{{ csrf_token }}',
    debug: {% if debug %}true{% else %}false{% endif %}
};

// Dados para o componente
const dashboardData = {
    usuario: {
        first_name: "{{ user.first_name|default:'Usu√°rio' }}", 
        username: "{{ user.username }}", 
        avatar_url: "{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% endif %}" 
    },
    estatisticas: { 
        total_unidades: {{ estatisticas.total_unidades|default:0 }}, 
        total_chamadas: {{ estatisticas.total_chamadas|default:0 }}, 
        chamadas_hoje: {{ estatisticas.chamadas_hoje|default:0 }}, 
        chamadas_mes: {{ estatisticas.chamadas_mes|default:0 }}, 
        executantes: {{ estatisticas.executantes|default:0 }}, 
        solicitantes: {{ estatisticas.solicitantes|default:0 }}, 
        executante_solicitante: {{ estatisticas.executante_solicitante|default:0 }} 
    },
    ultimas_unidades: [
        {% for unidade in ultimas_unidades %}
        {
            id: {{ unidade.id }},
            nome: "{{ unidade.nome|escapejs }}",
            tipo: "{{ unidade.tipo }}",
            created_at: "{{ unidade.created_at|date:'c' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ],
    ultimas_chamadas: [
        {% for chamada in ultimas_chamadas %}
        {
            id: {{ chamada.id }},
            nome_contato: "{{ chamada.nome_contato|escapejs }}",
            tipo_chamada: "{{ chamada.tipo_chamada }}",
            status: "{{ chamada.status }}",
            data_criacao: "{{ chamada.data_criacao|date:'c' }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ]
};

// Fun√ß√£o para mostrar debug info
function showDebugInfo() {
    const debugDiv = document.getElementById('debug-info');
    const debugContent = document.getElementById('debug-content');
    
    let info = '';
    info += `React: ${typeof React !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>`;
    info += `ReactDOM: ${typeof ReactDOM !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>`;
    info += `HomeReact: ${typeof window.HomeReact !== 'undefined' ? '‚úÖ' : '‚ùå'}<br>`;
    info += `Container: ${document.getElementById('home-react-root') ? '‚úÖ' : '‚ùå'}<br>`;
    
    debugContent.innerHTML = info;
    debugDiv.style.display = 'block';
}

// Fun√ß√£o para tentar carregar React
function tryLoadReact() {
    console.log('üîÑ Tentando carregar React...');
    
    const container = document.getElementById('home-react-root');
    const fallback = document.getElementById('fallback-content');
    
    if (!container) {
        console.error('‚ùå Container n√£o encontrado');
        return;
    }
    
    // Verificar depend√™ncias
    if (typeof React === 'undefined') {
        console.error('‚ùå React n√£o carregado');
        showError('React n√£o foi carregado. Verifique a conex√£o com a internet.');
        return;
    }
    
    if (typeof ReactDOM === 'undefined') {
        console.error('‚ùå ReactDOM n√£o carregado');
        showError('ReactDOM n√£o foi carregado. Verifique a conex√£o com a internet.');
        return;
    }
    
    if (typeof window.HomeReact === 'undefined') {
        console.error('‚ùå HomeReact n√£o carregado');
        showError('Componente HomeReact n√£o foi carregado. Verifique os arquivos est√°ticos.');
        return;
    }
    
    try {
        console.log('üöÄ Renderizando componente HomeReact...');
        
        // Ocultar fallback
        if (fallback) {
            fallback.style.display = 'none';
        }
        
        // Renderizar componente
        if (ReactDOM.createRoot) {
            const root = ReactDOM.createRoot(container);
            root.render(React.createElement(window.HomeReact, dashboardData));
        } else {
            ReactDOM.render(React.createElement(window.HomeReact, dashboardData), container);
        }
        
        console.log('‚úÖ Dashboard React carregado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao renderizar:', error);
        showError(`Erro ao renderizar: ${error.message}`);
        
        // Mostrar fallback em caso de erro
        if (fallback) {
            fallback.style.display = 'block';
        }
    }
}

// Fun√ß√£o para mostrar erros
function showError(message) {
    const container = document.getElementById('home-react-root');
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-container';
    errorDiv.innerHTML = `
        <h3>‚ö†Ô∏è Erro de Carregamento</h3>
        <p>${message}</p>
        <button onclick="tryLoadReact()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
            üîÑ Tentar Novamente
        </button>
        <button onclick="showFallback()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-left: 10px;">
            üìù Usar Modo Compatibilidade
        </button>
    `;
    
    container.innerHTML = '';
    container.appendChild(errorDiv);
}

// Fun√ß√£o para mostrar fallback
function showFallback() {
    const container = document.getElementById('home-react-root');
    const fallback = document.getElementById('fallback-content');
    
    container.innerHTML = '';
    if (fallback) {
        fallback.style.display = 'block';
        container.appendChild(fallback);
    }
}

// Inicializa√ß√£o
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìÑ DOM carregado, iniciando dashboard...');
    
    // Mostrar debug info se em modo debug
    if (window.REACT_CONFIG.debug) {
        setTimeout(showDebugInfo, 1000);
    }
    
    // Tentar carregar ap√≥s um pequeno delay
    setTimeout(tryLoadReact, 500);
});

// Fallback se DOMContentLoaded j√° passou
if (document.readyState === 'loading') {
    // DOM ainda carregando, aguardar DOMContentLoaded
} else {
    // DOM j√° carregado
    setTimeout(tryLoadReact, 100);
}
</script>
{% endblock %}